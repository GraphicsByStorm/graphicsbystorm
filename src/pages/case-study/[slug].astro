---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { WORKS } from '$lib/data/work';
import { WORK_META } from '$lib/data/workMeta';

export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () =>
  WORKS.map((w) => ({ params: { slug: w.slug } }));

// Local "details" shape (keeps this file independent of exported types)
type Details = {
  tools?: string;
  design?: string;
  creativity?: string;
  critique?: string;
  directions?: string;
  craftsmanship?: string;
};

const { slug } = Astro.params;
const base = WORKS.find((w) => w.slug === slug)!; // safe due to getStaticPaths
const meta = (WORK_META as Record<string, { details?: Details }>)[slug!] ?? {};
const item = { ...base, details: meta.details };

const { title, cover, images, tags, tools, highlights, summary } = item;

// Build rubric sections dynamically (only render those that exist)
const rubric = [
  { id: 'tools',         label: 'Working Knowledge of Software & Digital Tools', body: item.details?.tools },
  { id: 'design',        label: 'Elements & Principles of Design',               body: item.details?.design },
  { id: 'creativity',    label: 'Creative Self-Expression & Originality',        body: item.details?.creativity },
  { id: 'critique',      label: 'Thoughtful & Appropriate Critique Skills',      body: item.details?.critique },
  { id: 'directions',    label: 'Evidence of Following Directions',              body: item.details?.directions },
  { id: 'craftsmanship', label: 'Craftsmanship & Attention to Detail',           body: item.details?.craftsmanship },
].filter((s) => !!s.body);

// Prev/Next case studies
const currentIndex = WORKS.findIndex((w) => w.slug === slug);
const prev = currentIndex > 0 ? WORKS[currentIndex - 1] : null;
const next = currentIndex < WORKS.length - 1 ? WORKS[currentIndex + 1] : null;
---

<BaseLayout title={`${title} • Case Study`} description={summary}>
  <!-- Hero -->
  <header class="relative border-b border-white/10 bg-[var(--surface-1,#0b0b0b)]">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10">
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-white">
        <span class="mr-2 inline-block h-4 w-1.5 translate-y-[2px] rounded-full" style="background: var(--color-brand-500,#E2A028);"></span>
        {title}
      </h1>
      {tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {tags.map((t) => (
            <span class="rounded-full border border-white/10 bg-white/10 px-2 py-0.5 text-xs">{t}</span>
          ))}
        </div>
      )}
    </div>
    {cover && (
      <div class="border-t border-white/10">
        <img
          src={cover}
          alt=""
          class="w-full max-h-[52svh] object-cover object-top"
          loading="eager"
          decoding="async"
        />
      </div>
    )}
  </header>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-12 lg:py-14">
    <div class="grid gap-10 lg:grid-cols-[16rem_1fr_19rem]">
      <!-- TOC (sticky on desktop) -->
      <nav aria-label="On this page" class="hidden lg:block">
        <div class="sticky top-24 rounded-2xl border border-white/10 bg-white/[.04] p-4">
          <h2 class="text-sm font-bold text-white/80 mb-2">On this page</h2>
          <ol class="space-y-1 text-[13px] leading-snug">
            <li><a href="#overview" class="hover:underline">Overview</a></li>
            {highlights.length > 0 && <li><a href="#highlights" class="hover:underline">Highlights</a></li>}
            {rubric.map((s) => (
              <li><a href={`#${s.id}`} class="hover:underline">{s.label}</a></li>
            ))}
            {images.length > 0 && <li><a href="#gallery" class="hover:underline">Gallery</a></li>}
          </ol>
        </div>
      </nav>

      <!-- Main article -->
      <article class="min-w-0 space-y-10">
        <!-- Overview -->
        <section id="overview" aria-labelledby="overview-title">
          <h2 id="overview-title" class="text-xl font-extrabold text-white">Overview</h2>
          {summary && (
            <p class="mt-3 text-[1.05rem] leading-relaxed text-neutral-200/95">
              {summary}
            </p>
          )}
        </section>

        <!-- Highlights -->
        {highlights.length > 0 && (
          <section id="highlights" aria-labelledby="highlights-title">
            <h2 id="highlights-title" class="text-xl font-extrabold text-white">Highlights</h2>
            <ul class="mt-3 space-y-2 text-neutral-200/95">
              {highlights.map((h) => (
                <li class="flex gap-2">
                  <span class="select-none" aria-hidden="true">•</span>
                  <span>{h}</span>
                </li>
              ))}
            </ul>
          </section>
        )}

        <!-- Rubric sections -->
        {rubric.length > 0 && (
          <section aria-label="Case study details" class="grid gap-6 md:gap-7">
            {rubric.map((s) => (
              <div id={s.id} class="rounded-2xl border border-white/10 bg-white/[.045] p-5">
                <h3 class="text-lg font-bold text-white/95">{s.label}</h3>
                <p class="mt-2 text-neutral-200/95 leading-relaxed">{s.body}</p>
              </div>
            ))}
          </section>
        )}

        <!-- Gallery -->
        {images.length > 0 && (
          <section id="gallery" aria-labelledby="gallery-title">
            <h2 id="gallery-title" class="text-xl font-extrabold text-white">Gallery</h2>
            <div class="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {images.map((src) => (
                <a href={src} class="group overflow-hidden rounded-xl border border-white/10 bg-white/5">
                  <img
                    src={src}
                    alt=""
                    class="aspect-[4/3] w-full object-cover transition-transform duration-200 group-hover:scale-[1.02]"
                    loading="lazy"
                    decoding="async"
                  />
                </a>
              ))}
            </div>
          </section>
        )}
      </article>

      <!-- Project Info (sticky on desktop) -->
      <aside class="hidden lg:block">
        <div class="sticky top-24 space-y-4">
          <section class="rounded-2xl border border-white/10 bg-white/[.045] p-4">
            <h2 class="text-sm font-bold text-white/80 mb-2">Project info</h2>
            {tools.length > 0 && (
              <div class="mb-4">
                <div class="text-[12px] font-semibold text-white/70 mb-1.5">Tools</div>
                <div class="flex flex-wrap gap-1.5">
                  {tools.map((t) => (
                    <span class="rounded-full border border-white/10 bg-white/5 px-2 py-[2px] text-[11px]">{t}</span>
                  ))}
                </div>
              </div>
            )}
            {tags.length > 0 && (
              <div>
                <div class="text-[12px] font-semibold text-white/70 mb-1.5">Tags</div>
                <div class="flex flex-wrap gap-1.5">
                  {tags.map((t) => (
                    <span class="rounded-full border border-white/10 bg-white/5 px-2 py-[2px] text-[11px]">{t}</span>
                  ))}
                </div>
              </div>
            )}
          </section>

          <!-- Share (no JS; just a copyable URL) -->
          <section class="rounded-2xl border border-white/10 bg-white/[.045] p-4">
            <h2 class="text-sm font-bold text-white/80 mb-2">Share</h2>
            <input
              type="text"
              readonly
              value={`${Astro.site ? Astro.site.href.replace(/\/$/, '') : ''}/case-study/${slug}`}
              class="w-full rounded-md border border-white/15 bg-black/30 px-2 py-1 text-[12px] text-neutral-200"
              onclick="this.select()"
            />
          </section>
        </div>
      </aside>
    </div>

    <!-- Prev/Next nav -->
    {(prev || next) && (
      <nav class="mt-12 border-t border-white/10 pt-6 grid gap-3 sm:grid-cols-2" aria-label="Case study pagination">
        {prev && (
          <a href={`/case-study/${prev.slug}`} class="group rounded-xl border border-white/10 bg-white/[.045] p-4 hover:bg-white/[.065] transition">
            <div class="text-[11px] uppercase tracking-wide text-white/60">Previous</div>
            <div class="mt-1 text-[15px] font-semibold text-white group-hover:underline">{prev.title}</div>
          </a>
        )}
        {next && (
          <a href={`/case-study/${next.slug}`} class="group rounded-xl border border-white/10 bg-white/[.045] p-4 hover:bg-white/[.065] transition sm:text-right">
            <div class="text-[11px] uppercase tracking-wide text-white/60">Next</div>
            <div class="mt-1 text-[15px] font-semibold text-white group-hover:underline">{next.title}</div>
          </a>
        )}
      </nav>
    )}
  </main>
</BaseLayout>
