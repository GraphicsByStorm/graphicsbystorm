---
export const prerender = false;

import BaseLayout from "$layouts/BaseLayout.astro";
import Header from "$components/Header.astro";
import { prisma } from "$lib/db";

const { session, user } = Astro.locals;
if (!session) return Astro.redirect("/login");

const address = await prisma.address.findFirst({
  where: { userId: user!.id, isDefault: true }
});
---
<BaseLayout title="Account â€” GraphicsByStorm">
  <Header />
  <section class="section torn-top torn-angle-left" style="--torn-color: var(--color-surface-950);">
    <div class="section-inner space-y-8 max-w-3xl">
      <h1 class="heading-2 text-white">Account</h1>

      <form method="post" action="/api/account/update" class="space-y-6">
        <section class="card p-5 space-y-3">
          <h2 class="text-sm text-neutral-300">Profile</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input class="input" name="name" placeholder="Full name" value={user?.name ?? ""} />
            <input class="input" name="phone" placeholder="Phone" value={user?.phone ?? ""} />
          </div>
          <input class="input opacity-60" value={user?.email ?? ""} disabled />
        </section>

        <section class="card p-5 space-y-3">
          <h2 class="text-sm text-neutral-300">Billing address</h2>
          <input class="input" name="line1" placeholder="Address line 1" value={address?.line1 ?? ""} required />
          <input class="input" name="line2" placeholder="Address line 2 (optional)" value={address?.line2 ?? ""} />
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <input class="input" name="city" placeholder="City" value={address?.city ?? ""} required />
            <input class="input" name="state" placeholder="State/Region" value={address?.state ?? ""} />
            <input class="input" name="postal" placeholder="Postal code" value={address?.postal ?? ""} required />
          </div>
          <input class="input" name="country" placeholder="Country (e.g., US)" value={address?.country ?? ""} required />
        </section>

        <div class="flex gap-3 items-center">
          <button class="btn-brand">Save changes</button>
          <form method="post" action="/api/auth/logout">
            <button class="btn-ghost">Sign out</button>
          </form>
        </div>
      </form>
    </div>
  </section>
</BaseLayout>
